<!DOCTYPE html>
<title>Turntable Admin</title>

<head>
  <link rel="stylesheet" type="text/css" href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css">
  <link rel="stylesheet" type="text/css" href="/teleturn/lib/nv.d3.css">
  <link rel="stylesheet" type="text/css" href="/teleturn/teleturn.css">
  <link rel="stylesheet" type="text/css" href="/turntable/style.css">

  <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/2.10.0/d3.v2.min.js"></script>

  <script src="/teleturn/lib/nv.d3.js"></script>
  <script src="/teleturn/teleturn.js"></script>
  <script src="/turntable/config.js"></script>

  <script>
    window.teleturn = new Teleturn({
      baseUrl:    turntableBaseUrl,
      runPath:    "stage",
      addPath:    "add",
      removePath: "remove"
    });

    teleturn.clickQuery = function(d) {
      $("#name").val(d.opts.name);
      $("#query").val(d.query);
      $("#period").val(d.period);
    };

    teleturn.testQuery = function(opts) {
      runQuery(opts.db, opts.query);
    };

    teleturn.addTree("#query-tree");

    function runQuery(db, query) {
      $("#inspect-db").html(db);
      $("#inspect-query").html(query);
      var $button = $("#test");
      $button.attr("disabled", true);
      teleturn.runQuery({query: query, db: db}, function(d) {
        $("#inspect-results").val(d);
      }, function() {
        $button.attr("disabled", false);
      });
    };

    $(document).ready(function() {
      teleturn.addOpts("db", "#db");

      $("#add").click(function(e) {
        var $button = $(this);
        $button.attr("disabled", true);
        teleturn.addQuery({
          query: $("#query").val(),
          db: $("#db").val(),
          period: $("#period").val(),
          name: $("#name").val()
        }, function(d) {
          $button.attr("disabled", false);
        });
      });

      $("#test").click(function() {
        runQuery($("#db").val(), $("#query").val());
      });

      $("#name").focus(function(e) { $(this).attr("placeholder", "query:name") });
      $("#name").blur(function(e)  { $(this).attr("placeholder", "name")       });

      $("#period").focus(function(e) { $(this).attr("placeholder", "{:minute [0 15 30 45]}") });
      $("#period").blur(function(e)  { $(this).attr("placeholder", "run at")                 });
    });
  </script>

</head>

<body>
  <div id="add-container">
    <form>
      <select id="db"></select>
      <input type="text" id="name" placeholder="name"></input>
      <textarea id="query"></textarea>
      <input type="text" id="period" placeholder="run at"></input>
      <div id="buttons">
        <span id="test" class="btn">Test</span>
        <span id="add" class="btn">Add</span>
      </div>
    </form>
  </div>
  <div id="inspect-container">
    <div id="inspect-query" class="ellipsis inspect-header"></div>
    <div id="inspect-db" class="inspect-header"></div>
    <textarea id="inspect-results" disabled="disabled"></textarea>
  </div>
  <div id="query-tree">
  </div>
</body>
